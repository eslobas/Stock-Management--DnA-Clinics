<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gest√£o Stock - R√°pido</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f7fa; padding: 20px; color: #333; }
        .container { max-width: 1000px; margin: 0 auto; }
        h1 { color: #2c3e50; margin-bottom: 30px; text-align: center; }
        .painel-controle { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px; }
        .card { background: white; border-radius: 10px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); }
        h2 { color: #3498db; margin-bottom: 15px; font-size: 18px; }
        .input-group { margin-bottom: 15px; }
        input, button { padding: 10px 15px; border-radius: 6px; border: 1px solid #ddd; font-size: 14px; width: 100%; margin-bottom: 10px; }
        input:focus { outline: none; border-color: #3498db; box-shadow: 0 0 0 2px rgba(52,152,219,0.2); }
        .btn { background: #3498db; color: white; border: none; cursor: pointer; font-weight: 600; transition: background 0.2s; }
        .btn:hover { background: #2980b9; }
        .btn-vermelho { background: #e74c3c; }
        .btn-vermelho:hover { background: #c0392b; }
        .btn-verde { background: #2ecc71; }
        .btn-verde:hover { background: #27ae60; }
        .tabela-container { background: white; border-radius: 10px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        th { background: #f8f9fa; padding: 12px 15px; text-align: left; font-weight: 600; color: #2c3e50; border-bottom: 2px solid #eaeaea; }
        td { padding: 12px 15px; border-bottom: 1px solid #eaeaea; }
        tr:hover { background: #f9f9f9; }
        .stock-baixo { background-color: #fff3cd; }  /* Amarelo claro para stock baixo */
        .stock-baixo:hover { background-color: #ffe69b; }
        .acoes { white-space: nowrap; }
        .acoes button { width: auto; padding: 5px 10px; margin: 0 2px; font-size: 12px; }
        .qtd-input { width: 60px; text-align: center; padding: 5px; }
        .busca-container { margin-bottom: 20px; }
        .busca-input { width: 300px; max-width: 100%; }
        .mensagem { padding: 10px; border-radius: 6px; margin-bottom: 15px; display: none; }
        .sucesso { background: #d4edda; color: #155724; }
        .erro { background: #f8d7da; color: #721c24; }
        .stats { display: flex; gap: 15px; margin-top: 20px; }
        .stat { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); flex: 1; text-align: center; }
        .stat-numero { font-size: 24px; font-weight: bold; color: #3498db; }
        .stat-label { font-size: 12px; color: #7f8c8d; text-transform: uppercase; margin-top: 5px; }
        .aviso-icone { color: #e67e22; margin-left: 5px; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üì¶ Gest√£o R√°pida de Stock</h1>
        
        <div class="mensagem" id="mensagem"></div>
        
        <div class="painel-controle">
            <div class="card">
                <h2>Adicionar Produto</h2>
                <div class="input-group">
                    <input type="text" id="nomeNovo" placeholder="Nome do produto" autocomplete="off">
                    <input type="number" id="quantidadeNovo" placeholder="Quantidade" value="1" min="1">
                </div>
                <button class="btn btn-verde" onclick="adicionarProduto()">‚ûï Adicionar</button>
            </div>
            
            <div class="card">
                <h2>Buscar Produto</h2>
                <input type="text" id="busca" placeholder="Digite para buscar..." onkeyup="buscarProdutos()" autocomplete="off">
                <div class="stats">
                    <div class="stat">
                        <div class="stat-numero" id="totalProdutos">0</div>
                        <div class="stat-label">Total Produtos</div>
                    </div>
                    <div class="stat">
                        <div class="stat-numero" id="totalQuantidade">0</div>
                        <div class="stat-label">Total Unidades</div>
                    </div>
                    <div class="stat">
                        <div class="stat-numero" id="totalStockBaixo">0</div>
                        <div class="stat-label">Stock Baixo (<3)</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="tabela-container">
            <h2>Lista de Produtos</h2>
            <table id="tabelaProdutos">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Nome</th>
                        <th>Quantidade</th>
                        <th>A√ß√µes</th>
                    </tr>
                </thead>
                <tbody id="tabelaBody"></tbody>
            </table>
        </div>
    </div>

    <script>
        let produtos = [];
        let modoEdicao = false;
        let produtoEditando = null;
        
        document.addEventListener('DOMContentLoaded', carregarProdutos);
        
        async function carregarProdutos() {
            try {
                const response = await fetch('/api/produtos');
                produtos = await response.json();
                renderizarTabela(produtos);
                atualizarStats();
            } catch (erro) {
                mostrarMensagem('Erro ao carregar produtos', 'erro');
            }
        }
        
        async function buscarProdutos() {
            const termo = document.getElementById('busca').value.trim();
            if (termo === '') {
                renderizarTabela(produtos);
                return;
            }
            try {
                const response = await fetch(`/api/produtos/busca/${encodeURIComponent(termo)}`);
                const resultados = await response.json();
                renderizarTabela(resultados);
            } catch (erro) {
                mostrarMensagem('Erro na busca', 'erro');
            }
        }
        
        // Fun√ß√£o para validar quantidade antes de adicionar/atualizar
        function validarQuantidade(quantidade) {
            if (quantidade <= 0) {
                mostrarMensagem('‚ùå A quantidade deve ser maior que zero!', 'erro');
                return false;
            }
            if (quantidade <= 3) {
                return confirm('‚ö†Ô∏è Est√° a registar um produto com quantidade muito baixa (‚â§ 3). Deseja continuar?');
            }
            return true;
        }
        
        async function adicionarProduto() {
            const nome = document.getElementById('nomeNovo').value.trim();
            const quantidade = parseInt(document.getElementById('quantidadeNovo').value) || 0;
            
            if (!nome) {
                mostrarMensagem('Digite um nome para o produto', 'erro');
                return;
            }
            
            // Valida√ß√£o de quantidade
            if (!validarQuantidade(quantidade)) {
                return; // N√£o adiciona se a valida√ß√£o falhar
            }
            
            try {
                const response = await fetch('/api/produtos', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ nome, quantidade })
                });
                if (response.ok) {
                    document.getElementById('nomeNovo').value = '';
                    document.getElementById('quantidadeNovo').value = '1';
                    carregarProdutos();
                    mostrarMensagem('‚úÖ Produto adicionado com sucesso!', 'sucesso');
                }
            } catch (erro) {
                mostrarMensagem('Erro ao adicionar produto', 'erro');
            }
        }
        
        function iniciarEdicao(id) {
            const produto = produtos.find(p => p.id === id);
            if (!produto) return;
            modoEdicao = true;
            produtoEditando = id;
            document.getElementById('nomeNovo').value = produto.nome;
            document.getElementById('quantidadeNovo').value = produto.quantidade;
            const btn = document.querySelector('.btn-verde');
            btn.textContent = 'üîÑ Atualizar';
            btn.onclick = atualizarProduto;
        }
        
        async function atualizarProduto() {
            const nome = document.getElementById('nomeNovo').value.trim();
            const quantidade = parseInt(document.getElementById('quantidadeNovo').value) || 0;
            
            if (!nome) {
                mostrarMensagem('Digite um nome para o produto', 'erro');
                return;
            }
            
            // Valida√ß√£o de quantidade
            if (!validarQuantidade(quantidade)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/produtos/${produtoEditando}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ nome, quantidade })
                });
                if (response.ok) {
                    resetarFormulario();
                    carregarProdutos();
                    mostrarMensagem('‚úÖ Produto atualizado com sucesso!', 'sucesso');
                }
            } catch (erro) {
                mostrarMensagem('Erro ao atualizar produto', 'erro');
            }
        }
        
        async function eliminarProduto(id) {
            if (!confirm('Tem certeza que deseja eliminar este produto?')) return;
            try {
                const response = await fetch(`/api/produtos/${id}`, { method: 'DELETE' });
                if (response.ok) {
                    carregarProdutos();
                    mostrarMensagem('üóëÔ∏è Produto eliminado com sucesso!', 'sucesso');
                }
            } catch (erro) {
                mostrarMensagem('Erro ao eliminar produto', 'erro');
            }
        }
        
        async function atualizarQuantidadeRapida(id, novaQuantidade) {
            // Validar a nova quantidade
            if (novaQuantidade <= 0) {
                mostrarMensagem('‚ùå A quantidade deve ser maior que zero!', 'erro');
                // Reverter para o valor anterior (recarregar produtos)
                carregarProdutos();
                return;
            }
            
            if (novaQuantidade <= 3) {
                if (!confirm('‚ö†Ô∏è Est√° a definir uma quantidade muito baixa (‚â§ 3). Deseja continuar?')) {
                    carregarProdutos(); // Reverte
                    return;
                }
            }
            
            try {
                await fetch(`/api/produtos/${id}/quantidade`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ quantidade: novaQuantidade })
                });
                carregarProdutos();
            } catch (erro) {
                mostrarMensagem('Erro ao atualizar quantidade', 'erro');
                carregarProdutos();
            }
        }
        
        function renderizarTabela(listaProdutos) {
            const tbody = document.getElementById('tabelaBody');
            tbody.innerHTML = '';
            
            listaProdutos.forEach(produto => {
                const tr = document.createElement('tr');
                const isStockBaixo = produto.quantidade < 3;
                
                // Adiciona classe se stock baixo
                if (isStockBaixo) {
                    tr.className = 'stock-baixo';
                }
                
                // Nome com √≠cone de aviso se aplic√°vel
                const nomeDisplay = isStockBaixo 
                    ? `${produto.nome} <span class="aviso-icone">‚ö†Ô∏è</span>` 
                    : produto.nome;
                
                tr.innerHTML = `
                    <td>${produto.id}</td>
                    <td>${nomeDisplay}</td>
                    <td>
                        <input type="number" class="qtd-input" value="${produto.quantidade}" min="1"
                               onchange="atualizarQuantidadeRapida(${produto.id}, this.value)">
                    </td>
                    <td class="acoes">
                        <button class="btn" onclick="iniciarEdicao(${produto.id})">‚úèÔ∏è Editar</button>
                        <button class="btn btn-vermelho" onclick="eliminarProduto(${produto.id})">üóëÔ∏è Eliminar</button>
                    </td>
                `;
                
                tbody.appendChild(tr);
            });
        }
        
        function resetarFormulario() {
            modoEdicao = false;
            produtoEditando = null;
            document.getElementById('nomeNovo').value = '';
            document.getElementById('quantidadeNovo').value = '1';
            const btn = document.querySelector('.btn-verde');
            btn.textContent = '‚ûï Adicionar';
            btn.onclick = adicionarProduto;
        }
        
        function atualizarStats() {
            const totalProdutos = produtos.length;
            const totalQuantidade = produtos.reduce((sum, p) => sum + p.quantidade, 0);
            const totalStockBaixo = produtos.filter(p => p.quantidade < 3).length;
            
            document.getElementById('totalProdutos').textContent = totalProdutos;
            document.getElementById('totalQuantidade').textContent = totalQuantidade;
            document.getElementById('totalStockBaixo').textContent = totalStockBaixo;
        }
        
        function mostrarMensagem(texto, tipo) {
            const msg = document.getElementById('mensagem');
            msg.textContent = texto;
            msg.className = `mensagem ${tipo}`;
            msg.style.display = 'block';
            setTimeout(() => { msg.style.display = 'none'; }, 3000);
        }
        
        // Permitir adicionar/atualizar com Enter
        document.getElementById('nomeNovo').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                if (modoEdicao) atualizarProduto();
                else adicionarProduto();
            }
        });
    </script>
</body>
</html>